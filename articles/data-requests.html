<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="epivaultr">
<title>Data requests • epivaultr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Data requests">
<meta property="og:description" content="epivaultr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">epivaultr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/getting-started.html">Getting started</a>
    <a class="dropdown-item" href="../articles/data-requests.html">Data requests</a>
    <a class="dropdown-item" href="../articles/features-concepts.html">Concepts and features</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Data requests</h1>
            
      
      
      <div class="d-none name"><code>data-requests.Rmd</code></div>
    </div>

    
    
<p><a href="https://github.com/BornInBradford/epivaultr" class="external-link"><code>epivaultr</code></a>
is an R package used to extract data from EpiVault, the Born in Bradford
data warehouse. It can be used for quick grabs of specific variables
from specific tables. It can also be used to manage an entire data
request end to end, from reading a user’s requested variables, to
writing output files ready for shipping.</p>
<p>In this guide we will run a complete data request. This involves the
following steps:</p>
<ol style="list-style-type: decimal">
<li>Read the requested variables</li>
<li>Connect to EpiVault</li>
<li>Fetch the requested data from EpiVault</li>
<li>Disconnect from EpiVault</li>
<li>Write the output data files</li>
</ol>
<div class="section level2">
<h2 id="read-the-requested-variables">1 Read the requested variables<a class="anchor" aria-label="anchor" href="#read-the-requested-variables"></a>
</h2>
<p>A data request starts from a list of variables, provided in a
<code>csv</code> or <code>xlsx</code> file in one of a variety of <a href="https://borninbradford.github.io/epivaultr/articles/features-concepts.html#variable-names-and-file-formats">formats</a>.
The first task is to read the variables file into an <a href="https://borninbradford.github.io/epivaultr/articles/features-concepts.html#ev_variables---the-data-request"><code>ev_variables</code></a>
container, which contains all the information <a href="https://github.com/BornInBradford/epivaultr" class="external-link"><code>epivaultr</code></a>
needs to fetch the required data.</p>
<p>In the example we create an <a href="https://borninbradford.github.io/epivaultr/articles/features-concepts.html#ev_variables---the-data-request"><code>ev_variables</code></a>
container called <code>vars</code> that will hold all the information
about the requested variables.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://borninbradford.github.io/epivaultr/">epivaultr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create an `ev_variables` container called `vars` from the file `variables.csv`</span></span>
<span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_ev_variables.html">read_ev_variables</a></span><span class="op">(</span><span class="st">"tests/example_inputs/variables.csv"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="connect-to-epivault">2 Connect to EpiVault<a class="anchor" aria-label="anchor" href="#connect-to-epivault"></a>
</h2>
<p>An EpiVault instance is a SQL Server database. To make a connection
you specify the server name and database name of the instance you’re
connecting to. These can be set once using <code><a href="https://rdrr.io/r/base/options.html" class="external-link">options()</a></code> or can
be passed directly each time to the <code><a href="../reference/ev_connect.html">ev_connect()</a></code>
function.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># use `options` to define the connection</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>ev_server <span class="op">=</span> <span class="st">"BHTS-RESRCH22DV"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>ev_database <span class="op">=</span> <span class="st">"ResearchWarehouse"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># the connection token is returned in `con` to be used in data request functions</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ev_connect.html">ev_connect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fetch-the-requested-data">3 Fetch the requested data<a class="anchor" aria-label="anchor" href="#fetch-the-requested-data"></a>
</h2>
<p>So now we have:</p>
<table class="table">
<colgroup>
<col width="17%">
<col width="82%">
</colgroup>
<tbody>
<tr class="odd">
<td><code>vars</code></td>
<td>An <a href="https://borninbradford.github.io/epivaultr/articles/features-concepts.html#ev_variables---the-data-request"><code>ev_variables</code></a>
container with the details of the data request</td>
</tr>
<tr class="even">
<td><code>con</code></td>
<td>An EpiVault connection token</td>
</tr>
</tbody>
</table>
<p>We’re ready to pass these to the next step to fetch the required
data. The requested data tables and associated metadata are bundled into
an <a href="https://borninbradford.github.io/epivaultr/articles/features-concepts.html#ev_data---the-data-extract"><code>ev_data</code></a>
container.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create an `ev_data` container called `dat` that will hold all of the data returned</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fetch_ev_data.html">fetch_ev_data</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">vars</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="missing-variables-and-things-to-check">3.1 Missing variables and things to check<a class="anchor" aria-label="anchor" href="#missing-variables-and-things-to-check"></a>
</h3>
<p>If any of the requested variables are not found in the EpiVault
instance, R will return a warning message listing the variables
concerned. You should check these and correct any variables with
misspelt names or incorrect project/table references.</p>
<p>The <code><a href="../reference/fetch_ev_data.html">fetch_ev_data()</a></code> function also takes a
<code>visibility</code> parameter. Most data requests will be run at
visibility level 0, which is the default, so this parameter doesn’t
usually need to be specified. However, variable visibility can also lead
to missing variable warnings: if a variable has a higher visibility
level set in EpiVault than the level requested, it will be reported as
not found. So, a missing variable warning can also be caused by a
variable requiring a higher visibility privilege than your current
setting. See <a href="https://borninbradford.github.io/epivaultr/articles/features-concepts.html#variable-visibility">Variable
visibility</a> for more information.</p>
</div>
</div>
<div class="section level2">
<h2 id="disconnect-from-epivault">4 Disconnect from EpiVault<a class="anchor" aria-label="anchor" href="#disconnect-from-epivault"></a>
</h2>
<p>Now we no longer need the connection to EpiVault, it is good practice
to disconnect.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ev_disconnect.html">ev_disconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="write-the-output-data-files">5 Write the output data files<a class="anchor" aria-label="anchor" href="#write-the-output-data-files"></a>
</h2>
<p>For convenience in processing data requests, you can use
<code><a href="../reference/write_ev_data.html">write_ev_data()</a></code> to output all data and metadata files in a
chosen file format.</p>
<p>To skip metadata outputs, set <code>metadata</code> to
<code>FALSE</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># output all data and metadata tables in Stata format using the file prefix `my_data`</span></span>
<span><span class="fu"><a href="../reference/write_ev_data.html">write_ev_data</a></span><span class="op">(</span><span class="va">dat</span>, </span>
<span>              path <span class="op">=</span> <span class="st">"H:/DataRequests/output"</span>,</span>
<span>              name <span class="op">=</span> <span class="st">"my_data"</span>,</span>
<span>              format <span class="op">=</span> <span class="st">"stata"</span>,</span>
<span>              metadata <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>If more fine-grained control of outputs is needed, the data and
metadata tables in <code>dat</code> can be accessed using various <a href="https://borninbradford.github.io/epivaultr/reference/index.html#get-data-from-containers"><code>get_</code></a>
functions.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dan Mason.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
